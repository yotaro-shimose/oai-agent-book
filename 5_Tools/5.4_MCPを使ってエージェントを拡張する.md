# 5.4 MCPを使ってエージェントを拡張する

前節までで、関数ツール、Hosted Tool、エージェントをツールとして使う方法について学びました。本節では、ツールを定義するための新しいアプローチである「MCP（Model Context Protocol）」について学んでいきます。

## MCPとは

MCP（Model Context Protocol）は、エージェントのツールを定義するための標準化されたプロトコルです。これまで学んできた`@function_tool`デコレータは簡単で使いやすいですが、MCPはより体系的かつ拡張性の高いアプローチを提供します。

MCPの最大の利点は、**ツールの共有と再利用が非常に簡単になる**ことです。標準化されたインターフェースを通じて、異なる言語やフレームワークで実装されたツールを簡単に統合でき、コミュニティ全体でツールを共有することができます。MCPによって技術的に新しいことができるようになるわけではありませんが、ツールの実装と共有のプロセスが効率化されます。「別にgit repositoryをcloneしてビルドしてもできるけど`pip install`で他人のシステムを導入できたらうれしい」と近い感情かもしれません。

実際に多くの場合で、コマンドとその引数を指定するだけでMCPサーバーを設定できます。例えば、ファイルシステムを利用できるようにするためのMCPサーバーの設定は以下のようなJSONをVSCodeやClineなどのエージェントシステムの設定ファイルに追加するだけです：

```json
{
  "mcpServers": {
    "filesystem": {
      "command": "npx",
      "args": [
        "-y",
        "@modelcontextprotocol/server-filesystem",
        "/Users/username/Desktop",
        "/path/to/other/allowed/dir"
      ]
    }
  }
}
```

この簡単な設定だけで、エージェントはファイルシステムにアクセスし、ファイルの作成、編集、読み取りなどの操作を行うことができるようになります。これにより、開発者は複雑なツールの導入に時間を費やすことなく、エージェントの機能を拡張することができます。

## MCPを使ったエージェントの作成

以下のコード例を見てみましょう。このコードでは、MCPを使用してファイルシステムとやりとりするエージェントを実装しています：

```python
from agents import Agent, Runner
from agents.mcp import MCPServerStdio
from dotenv import load_dotenv


async def main():
    load_dotenv()
    async with MCPServerStdio(
        params={
            "command": "npx",
            "args": ["-y", "@modelcontextprotocol/server-filesystem", "./mcp_sandbox"],
        }
    ) as server:
        agent = Agent(
            name="Research Assistant",
            instructions="""\
あなたはリサーチアシスタントです。ユーザーの要求にツールを用いて応じます。

""",
            model="gpt-4.1-mini",
            mcp_servers=[server],
        )

        # ユーザーからの質問
        user_input = "server.pyとclient.pyというファイルを作成してください。その中にFastAPIを使ってオウム返しするAPIを実装してください。さらに、client.pyからserver.pyにリクエストを送信してオウム返しの結果を表示するようにしてください。"
        response = await Runner.run(agent, input=user_input, max_turns=30)
        print(response.final_output)


if __name__ == "__main__":
    import asyncio

    asyncio.run(main())
```

このコードでは、以下のことを行っています：

1. **MCPサーバーの起動**：
   `MCPServerStdio`を使用して、`@modelcontextprotocol/server-filesystem`というnpmパッケージを実行しています。このパッケージは、ファイルシステムとやりとりするためのMCPサーバーを提供します。

2. **エージェントの作成**：
   `mcp_servers`パラメータにMCPサーバーを指定してエージェントを作成しています。これにより、エージェントはMCPサーバーが提供するツールを使用できるようになります。

3. **エージェントの実行**：
   ユーザーからの入力に対してエージェントを実行し、結果を表示しています。

## エージェントと外界の相互作用

このコード例の最も重要な点は、エージェントがファイルシステムと直接やりとりできるようになったことです。これにより、エージェントは以下のようなことができるようになります：

1. **ファイルの作成と編集**：
   エージェントはserver.pyとclient.pyというファイルを作成し、FastAPIを使ったコードを実装できます。

2. **ディレクトリの操作**：
   必要に応じてディレクトリを作成したり、ファイルを移動したりできます。

3. **ファイルの読み取り**：
   既存のファイルを読み取り、その内容を理解した上で作業を進めることができます。

これは、エージェントが「外界」と相互作用できるようになったことを意味します。これまでのエージェントは、与えられた情報を処理して回答を返すだけでしたが、MCPを使用することで、エージェントは実際の環境に変化を与えることができるようになりました。

## まとめ

MCPは、エージェントのツールを定義するための標準化されたプロトコルです。`@function_tool`デコレータと比較して新しいことができるようになるわけではありませんが、ツールの実装と共有が効率的にできるようになります。

さて、この本を通じてはじめてエージェントがファイルシステムという「外界」と相互作用できるようになりました。最近ではAzureやAWSなどがクラウドを操作できるMCPを公開していますね。将来的にはさらに多くの外部システムとの連携が可能になるでしょう。

これにより、エージェントはより実用的なタスクを自律的に実行できるようになり、私たちの生活やビジネスにより大きな影響を与えることができるようになります。